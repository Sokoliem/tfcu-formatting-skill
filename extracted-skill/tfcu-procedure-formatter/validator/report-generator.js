/**
 * TFCU Procedure Formatter - Report Generator
 *
 * Generates compliance reports in multiple formats:
 * - JSON: Machine-readable format for CI/CD
 * - Markdown: Human-readable format for documentation
 * - HTML: Visual format for browser viewing
 */

/**
 * Generate a compliance report from validation results
 * @param {Object} results - Results from validateDocument()
 * @param {Object} options - Report options
 * @returns {Object} Report in requested format
 */
function generateReport(results, options = {}) {
  const {
    format = "json",
    documentPath = "unknown",
    specVersion = "2.3",
  } = options;

  const report = {
    meta: {
      documentPath,
      specVersion,
      validatedAt: new Date().toISOString(),
      generatorVersion: "3.0.0",
    },
    summary: calculateSummary(results),
    categories: results.categories,
    passed: results.passed,
    failed: results.failed,
    warnings: results.warnings,
  };

  switch (format.toLowerCase()) {
    case "markdown":
    case "md":
      return toMarkdown(report);
    case "html":
      return toHtml(report);
    case "json":
    default:
      return report;
  }
}

/**
 * Calculate summary statistics
 * @param {Object} results - Validation results
 * @returns {Object} Summary
 */
function calculateSummary(results) {
  const totalChecks =
    results.passed.length + results.failed.length + results.warnings.length;
  const passedCount = results.passed.length;
  const failedCount = results.failed.length;
  const warningCount = results.warnings.length;

  return {
    totalChecks,
    passed: passedCount,
    failed: failedCount,
    warnings: warningCount,
    compliancePercentage:
      totalChecks > 0
        ? Math.round((passedCount / (passedCount + failedCount)) * 100 * 10) /
          10
        : 100,
    status: failedCount === 0 ? "PASSED" : "FAILED",
  };
}

/**
 * Convert report to Markdown format
 * @param {Object} report - Report object
 * @returns {string} Markdown content
 */
function toMarkdown(report) {
  const lines = [];

  // Header
  lines.push("# TFCU Procedure Compliance Report");
  lines.push("");
  lines.push(`**Document**: ${report.meta.documentPath}`);
  lines.push(
    `**Validated**: ${new Date(report.meta.validatedAt).toLocaleString()}`,
  );
  lines.push(`**Spec Version**: ${report.meta.specVersion}`);
  lines.push("");

  // Summary
  lines.push("## Summary");
  lines.push("");
  lines.push("| Metric | Value |");
  lines.push("|--------|-------|");
  lines.push(
    `| Status | ${report.summary.status === "PASSED" ? "PASSED" : "**FAILED**"} |`,
  );
  lines.push(`| Total Checks | ${report.summary.totalChecks} |`);
  lines.push(`| Passed | ${report.summary.passed} |`);
  lines.push(`| Failed | ${report.summary.failed} |`);
  lines.push(`| Warnings | ${report.summary.warnings} |`);
  lines.push(`| Compliance | ${report.summary.compliancePercentage}% |`);
  lines.push("");

  // Categories breakdown
  lines.push("## Results by Category");
  lines.push("");

  Object.entries(report.categories).forEach(([category, stats]) => {
    const status = stats.failed === 0 ? "pass" : "fail";
    lines.push(`### ${capitalize(category)} (${stats.passed}/${stats.total})`);
    lines.push("");
  });

  // Failed checks
  if (report.failed.length > 0) {
    lines.push("## Failed Checks");
    lines.push("");

    report.failed.forEach((check, i) => {
      lines.push(`### ${i + 1}. ${check.ruleId}: ${check.description}`);
      lines.push("");
      if (check.actual !== undefined) {
        lines.push(`- **Actual**: \`${formatValue(check.actual)}\``);
      }
      if (check.expected !== undefined) {
        lines.push(`- **Expected**: \`${formatValue(check.expected)}\``);
      }
      if (check.error?.suggestion) {
        lines.push(`- **Fix**: ${check.error.suggestion}`);
      }
      lines.push("");
    });
  }

  // Warnings
  if (report.warnings.length > 0) {
    lines.push("## Warnings");
    lines.push("");

    report.warnings.forEach((warn, i) => {
      lines.push(`${i + 1}. **${warn.ruleId}**: ${warn.description}`);
      if (warn.actual !== undefined) {
        lines.push(`   - Actual: \`${formatValue(warn.actual)}\``);
      }
    });
    lines.push("");
  }

  // Passed checks (collapsed)
  if (report.passed.length > 0) {
    lines.push("## Passed Checks");
    lines.push("");
    lines.push("<details>");
    lines.push("<summary>View all passed checks</summary>");
    lines.push("");

    report.passed.forEach((check) => {
      lines.push(`- [x] **${check.ruleId}**: ${check.description}`);
    });

    lines.push("");
    lines.push("</details>");
    lines.push("");
  }

  // Footer
  lines.push("---");
  lines.push(
    `*Generated by TFCU Procedure Validator v${report.meta.generatorVersion}*`,
  );

  return lines.join("\n");
}

/**
 * Convert report to HTML format
 * @param {Object} report - Report object
 * @returns {string} HTML content
 */
function toHtml(report) {
  const statusClass = report.summary.status === "PASSED" ? "passed" : "failed";

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TFCU Compliance Report</title>
  <style>
    body { font-family: Calibri, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { color: #154747; border-bottom: 2px solid #154747; padding-bottom: 10px; }
    h2 { color: #154747; margin-top: 30px; }
    .summary { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .summary.passed { border-left: 4px solid #548235; }
    .summary.failed { border-left: 4px solid #C00000; }
    .status-passed { color: #548235; font-weight: bold; }
    .status-failed { color: #C00000; font-weight: bold; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #154747; color: white; }
    .check-passed { color: #548235; }
    .check-failed { color: #C00000; }
    .check-warning { color: #FFC000; }
    .error-details { background: #F8D7DA; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #C00000; }
    .warning-details { background: #FFF2CC; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #FFC000; }
    code { background: #e8e8e8; padding: 2px 6px; border-radius: 3px; font-family: Consolas, monospace; }
    .categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .category { background: #E8F4F4; padding: 15px; border-radius: 8px; }
    .category h3 { margin: 0 0 10px 0; color: #154747; }
    .progress { height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 100%; background: #548235; }
  </style>
</head>
<body>
  <h1>TFCU Procedure Compliance Report</h1>

  <div class="summary ${statusClass}">
    <h2 style="margin-top: 0;">Summary</h2>
    <p><strong>Document:</strong> ${escapeHtml(report.meta.documentPath)}</p>
    <p><strong>Validated:</strong> ${new Date(report.meta.validatedAt).toLocaleString()}</p>
    <p><strong>Status:</strong> <span class="status-${statusClass}">${report.summary.status}</span></p>
    <table>
      <tr><th>Metric</th><th>Value</th></tr>
      <tr><td>Total Checks</td><td>${report.summary.totalChecks}</td></tr>
      <tr><td>Passed</td><td class="check-passed">${report.summary.passed}</td></tr>
      <tr><td>Failed</td><td class="check-failed">${report.summary.failed}</td></tr>
      <tr><td>Warnings</td><td class="check-warning">${report.summary.warnings}</td></tr>
      <tr><td>Compliance</td><td><strong>${report.summary.compliancePercentage}%</strong></td></tr>
    </table>
  </div>

  <h2>Results by Category</h2>
  <div class="categories">
    ${Object.entries(report.categories)
      .map(
        ([name, stats]) => `
      <div class="category">
        <h3>${capitalize(name)}</h3>
        <div class="progress">
          <div class="progress-bar" style="width: ${stats.total > 0 ? (stats.passed / stats.total) * 100 : 100}%"></div>
        </div>
        <p>${stats.passed}/${stats.total} passed</p>
      </div>
    `,
      )
      .join("")}
  </div>

  ${
    report.failed.length > 0
      ? `
    <h2>Failed Checks (${report.failed.length})</h2>
    ${report.failed
      .map(
        (check, i) => `
      <div class="error-details">
        <h3>${i + 1}. ${escapeHtml(check.ruleId)}</h3>
        <p><strong>Description:</strong> ${escapeHtml(check.description)}</p>
        ${check.actual !== undefined ? `<p><strong>Actual:</strong> <code>${escapeHtml(formatValue(check.actual))}</code></p>` : ""}
        ${check.expected !== undefined ? `<p><strong>Expected:</strong> <code>${escapeHtml(formatValue(check.expected))}</code></p>` : ""}
        ${check.error?.suggestion ? `<p><strong>Fix:</strong> ${escapeHtml(check.error.suggestion)}</p>` : ""}
      </div>
    `,
      )
      .join("")}
  `
      : ""
  }

  ${
    report.warnings.length > 0
      ? `
    <h2>Warnings (${report.warnings.length})</h2>
    ${report.warnings
      .map(
        (warn, i) => `
      <div class="warning-details">
        <h3>${i + 1}. ${escapeHtml(warn.ruleId)}</h3>
        <p>${escapeHtml(warn.description)}</p>
      </div>
    `,
      )
      .join("")}
  `
      : ""
  }

  <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; color: #666; font-size: 0.9em;">
    Generated by TFCU Procedure Validator v${report.meta.generatorVersion}
  </footer>
</body>
</html>`;
}

/**
 * Capitalize first letter
 * @param {string} str - Input string
 * @returns {string}
 */
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

/**
 * Format a value for display
 * @param {any} value - Value to format
 * @returns {string}
 */
function formatValue(value) {
  if (Array.isArray(value)) {
    return value.join(", ");
  }
  if (typeof value === "object" && value !== null) {
    return JSON.stringify(value);
  }
  return String(value);
}

/**
 * Escape HTML special characters
 * @param {string} str - Input string
 * @returns {string}
 */
function escapeHtml(str) {
  if (typeof str !== "string") return String(str);
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

module.exports = { generateReport };
