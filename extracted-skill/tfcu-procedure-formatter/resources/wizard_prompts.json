{
  "version": "2.0",
  "description": "Question templates and decision trees for the Interactive Procedure Wizard - v5.0+ with mandatory enforcement and auto-insert",

  "activation_triggers": [
    "wizard",
    "interactive",
    "interactive mode",
    "create procedure",
    "new procedure",
    "write procedure",
    "revise procedure",
    "update procedure",
    "reformat procedure",
    "help me with a procedure",
    "procedure wizard",
    "draft a procedure",
    "build a procedure"
  ],

  "phases": {
    "intake": {
      "phase_number": 1,
      "estimated_minutes": "2-3",
      "questions": [
        {
          "id": "mode",
          "prompt": "What would you like to do?",
          "options": [
            {"value": "new", "label": "Create a new procedure from scratch"},
            {"value": "revise", "label": "Revise/reformat an existing procedure"},
            {"value": "quick", "label": "Quick format (minimal questions, fast output)"}
          ],
          "branching": {
            "new": "continue_to_type",
            "revise": "request_document",
            "quick": "quick_mode_questions"
          }
        },
        {
          "id": "procedure_type",
          "prompt": "What type of procedure is this?",
          "options": [
            {"value": "operational", "label": "Operational", "description": "Day-to-day tasks, system usage"},
            {"value": "compliance", "label": "Compliance", "description": "Regulatory requirements, BSA/AML, auditable"},
            {"value": "system", "label": "System", "description": "Software/application specific, screenshot-heavy"},
            {"value": "service", "label": "Member Service", "description": "Member-facing interactions"},
            {"value": "admin", "label": "Administrative", "description": "Internal processes, HR, facilities"}
          ],
          "implications": {
            "operational": {
              "sections": ["header", "overview", "quick_reference", "prerequisites", "steps", "troubleshooting", "revision_history"],
              "screenshot_frequency": "medium",
              "callout_emphasis": "tips"
            },
            "compliance": {
              "sections": ["header", "overview", "regulatory_references", "quick_reference", "prerequisites", "approval_matrix", "steps", "audit_trail", "troubleshooting", "revision_history"],
              "screenshot_frequency": "low",
              "callout_emphasis": "critical",
              "special_triggers": ["ctr", "bsa", "aml", "sar"]
            },
            "system": {
              "sections": ["header", "overview", "quick_reference", "prerequisites", "steps", "troubleshooting", "revision_history"],
              "screenshot_frequency": "high",
              "callout_emphasis": "warnings"
            },
            "service": {
              "sections": ["header", "overview", "quick_reference", "prerequisites", "steps", "member_communication", "troubleshooting", "revision_history"],
              "screenshot_frequency": "low",
              "callout_emphasis": "tips"
            },
            "admin": {
              "sections": ["header", "overview", "prerequisites", "steps", "revision_history"],
              "screenshot_frequency": "low",
              "callout_emphasis": "info"
            }
          }
        },
        {
          "id": "audience",
          "prompt": "Who is the primary audience?",
          "options": [
            {"value": "frontline", "label": "Frontline staff", "description": "Tellers, MSRs"},
            {"value": "backoffice", "label": "Back office staff", "description": "Operations, accounting"},
            {"value": "management", "label": "Management", "description": "Supervisors, directors"},
            {"value": "all", "label": "All staff", "description": "Organization-wide"}
          ],
          "implications": {
            "frontline": {"detail_level": "high", "screenshot_need": "high", "jargon_allowed": false},
            "backoffice": {"detail_level": "medium", "screenshot_need": "medium", "jargon_allowed": true},
            "management": {"detail_level": "low", "screenshot_need": "low", "jargon_allowed": true},
            "all": {"detail_level": "high", "screenshot_need": "medium", "jargon_allowed": false}
          }
        },
        {
          "id": "department",
          "prompt": "Which department owns this procedure?",
          "input_type": "text",
          "suggestions": [
            "Card Services",
            "Member Services",
            "Operations",
            "Lending",
            "Accounting",
            "Compliance",
            "IT",
            "HR",
            "Marketing"
          ]
        }
      ]
    },

    "quick_mode": {
      "phase_number": 1.5,
      "description": "Minimal questions for fast output - skips most prompts, applies defaults",
      "estimated_minutes": "5-8",
      "activation": "User selects 'quick' in intake phase mode selection",
      "questions": [
        {
          "id": "quick_title",
          "prompt": "What is the procedure name?",
          "input_type": "text",
          "validation": {
            "min_length": 5,
            "max_length": 100
          }
        },
        {
          "id": "quick_department",
          "prompt": "Which department owns this?",
          "input_type": "select",
          "options": [
            {"value": "Card_Services", "label": "Card Services"},
            {"value": "Member_Services", "label": "Member Services"},
            {"value": "Operations", "label": "Operations"},
            {"value": "Lending", "label": "Lending"},
            {"value": "Accounting", "label": "Accounting"},
            {"value": "Compliance", "label": "Compliance"},
            {"value": "IT", "label": "IT"},
            {"value": "HR", "label": "HR"},
            {"value": "Marketing", "label": "Marketing"}
          ]
        },
        {
          "id": "quick_content",
          "prompt": "Paste the procedure content or describe the key steps:",
          "input_type": "multiline_text",
          "guidance": "Paste existing content to convert, or type a description of the steps"
        }
      ],
      "defaults_applied": {
        "procedure_type": "operational",
        "audience": "frontline",
        "screenshot_frequency": "medium",
        "callout_emphasis": "auto_detect",
        "detail_level": "high"
      },
      "skipped_phases": ["foundation", "step_construction"],
      "proceeds_to": "quality_assurance",
      "auto_processing": {
        "description": "Claude automatically processes the pasted content",
        "actions": [
          "Apply terminology corrections (suggestion_triggers.json)",
          "Scan for hard-stop patterns (TFCU-specific content)",
          "Auto-insert verification steps and callouts",
          "Generate screenshot placeholders where patterns match",
          "Flag uncertainty items for Phase 3.5"
        ],
        "if_hard_stops_found": "Enter Phase 3.5 Uncertainty Resolution before QA",
        "if_no_hard_stops": "Proceed directly to Phase 4 QA"
      }
    },

    "foundation": {
      "phase_number": 2,
      "estimated_minutes": "5-8",
      "questions": [
        {
          "id": "title",
          "prompt": "What should this procedure be called?",
          "guidance": "Use action-oriented titles like 'Processing Wire Transfers' rather than noun phrases like 'Wire Transfer Procedure'",
          "validation": {
            "min_length": 5,
            "max_length": 100,
            "discouraged_patterns": ["procedure$", "policy$", "^the "]
          }
        },
        {
          "id": "overview",
          "prompt": "Briefly describe the purpose of this procedure (1-2 sentences)",
          "guidance": "Start with 'This procedure...' and explain what it accomplishes",
          "validation": {
            "max_sentences": 3,
            "max_words": 50
          }
        },
        {
          "id": "prerequisites",
          "prompt": "What must be true BEFORE someone can perform this procedure?",
          "input_type": "list",
          "suggestions_by_type": {
            "system": ["System access granted", "Login credentials", "Required training completed"],
            "compliance": ["Appropriate approval authority", "Required certifications", "Access to reporting systems"],
            "operational": ["System access", "Required materials available"],
            "service": ["Member account pulled up", "Identity verified"],
            "admin": ["Appropriate permissions", "Required forms available"]
          }
        },
        {
          "id": "quick_reference",
          "prompt": "Does this procedure have critical reference values staff need at-a-glance?",
          "conditional": true,
          "show_when": "procedure_type in ['operational', 'system', 'compliance']",
          "prefill_suggestions": {
            "card_services": [
              {"label": "Card@Once Support", "value": "1-800-237-3387"},
              {"label": "Consumer Debit BIN", "value": "41139300"},
              {"label": "Business Debit BIN", "value": "42616400"}
            ],
            "wire_transfers": [
              {"label": "Wire Cutoff Time", "value": "3:00 PM local"},
              {"label": "Fed Wire Routing", "value": "Contact Operations"}
            ]
          }
        },
        {
          "id": "related_links",
          "prompt": "Are there related policies, procedures, or forms?",
          "input_type": "categorized_list",
          "categories": ["Policies", "Procedures", "Forms"]
        }
      ]
    },

    "step_construction": {
      "phase_number": 3,
      "estimated_minutes": "10-30",
      "loop_structure": {
        "section_prompt": "What section are we working on?",
        "step_prompt": "What action does the user take in this step?",
        "substep_prompt": "Does this step have sub-actions?",
        "continue_prompt": "Add another step to this section?",
        "section_complete_prompt": "Add another section?"
      },
      "inline_checks": [
        "terminology",
        "sentence_length",
        "action_verb",
        "passive_voice"
      ],
      "decision_points": [
        "screenshot_needed",
        "callout_needed",
        "verification_step_needed",
        "troubleshooting_entry_needed"
      ]
    },

    "quality_assurance": {
      "phase_number": 4,
      "estimated_minutes": "3-5",
      "automated_checks": [
        {
          "id": "terminology",
          "name": "Terminology Compliance",
          "tool": "terminology_validator.py"
        },
        {
          "id": "sentence_length",
          "name": "Sentence Length",
          "threshold": 25,
          "max": 35
        },
        {
          "id": "passive_voice",
          "name": "Passive Voice Detection",
          "patterns": ["should be", "needs to be", "must be", "will be", "can be", "is to be"]
        },
        {
          "id": "acronym_definitions",
          "name": "Acronym Definitions",
          "required_list": ["BIN", "PIN", "MICR", "GOLD", "ATM", "ACH", "BSA", "AML", "CTR", "SAR"]
        }
      ],
      "gap_analysis": [
        "missing_troubleshooting",
        "missing_verification_steps",
        "missing_screenshots_for_complex_steps",
        "undefined_acronyms",
        "compliance_callouts_needed"
      ]
    },

    "section_validation": {
      "phase_number": 4.5,
      "description": "Validate document structure against spec-config.js - self-correcting",
      "estimated_minutes": "automatic",
      "checks": [
        {"id": "header_table", "required": true, "description": "Row 1 dark teal, Row 2 light teal"},
        {"id": "overview_section", "required": true, "description": "Max 3 sentences, starts with 'This procedure...'"},
        {"id": "related_section", "required": true, "description": "Categorized links"},
        {"id": "body_steps", "required": true, "description": "Two-column table for screenshot steps (55/45)"},
        {"id": "revision_history", "required": true, "description": "On new page, 3-column table"},
        {"id": "footer", "required": true, "description": "Department, procedure name, page number, version watermark"},
        {"id": "table_of_contents", "conditional": true, "condition": "page_count > 3", "description": "Inline horizontal format"},
        {"id": "quick_reference", "conditional": true, "condition": "has_critical_values", "description": "4-column teal format"},
        {"id": "troubleshooting", "conditional": true, "condition": "has_error_patterns", "description": "3-column format"}
      ],
      "enforcement": "self_correcting",
      "note": "Model applies spec-config.js values programmatically - no user intervention needed"
    },

    "output": {
      "phase_number": 5,
      "estimated_minutes": "2-3",
      "mandatory_bundle": true,
      "description": "All outputs are MANDATORY - no prompting required",
      "deliverables": [
        {
          "id": "procedure_doc",
          "name": "Procedure Document",
          "format": "docx",
          "filename_pattern": "{Department}_{ProcedureName}_{YYYYMM}.docx",
          "mandatory": true,
          "includes": ["formatted_content", "screenshot_placeholders", "auto_inserted_verification_steps", "auto_inserted_callouts"]
        },
        {
          "id": "assessment",
          "name": "Training Assessment",
          "format": "docx",
          "filename_pattern": "{ProcedureName}_Assessment_{YYYYMM}.docx",
          "mandatory": true,
          "includes": ["competency_questions", "answer_key", "scoring_guidance"]
        },
        {
          "id": "quick_card",
          "name": "Quick Reference Card",
          "format": "docx",
          "filename_pattern": "{ProcedureName}_QuickCard_{YYYYMM}.docx",
          "mandatory": true,
          "includes": ["key_steps", "callouts", "escalation_triggers", "contacts"]
        },
        {
          "id": "validation_report",
          "name": "Validation Report",
          "format": "txt",
          "filename_pattern": "{ProcedureName}_ValidationReport.txt",
          "mandatory": true,
          "includes": ["schema_compliance", "coverage_analysis", "terminology_corrections", "remaining_markers"]
        }
      ],
      "filename_generation": {
        "_spec_ref": "See validator/spec-config.js â†’ filenameConventions for authoritative rules",
        "enforce": true,
        "validate_department": true,
        "validate_procedure_name": true,
        "auto_sanitize": true,
        "show_preview_in_phase": 1,
        "preview_template": "OUTPUT FILES (auto-generated)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nBased on your inputs:\n  Department: {department}\n  Procedure: {procedure_name}\n\nYour files will be named:\n  ðŸ“„ {procedure_filename}\n  ðŸ“ {assessment_filename}\n  ðŸ—‚ï¸ {quickcard_filename}\n  âœ“  {report_filename}\n\n[These names are standardized automatically - no manual override needed]\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",
        "on_invalid_department": "prompt_selection",
        "on_sanitized_name": "show_notification",
        "functions": {
          "generateFilename": "validated-helpers.js â†’ generateFilename(type, department, procedureName, ctx)",
          "generateOutputBundle": "validated-helpers.js â†’ generateOutputBundle(department, procedureName, ctx)",
          "getValidDepartments": "validated-helpers.js â†’ getValidDepartments()"
        }
      }
    }
  },

  "decision_trees": {
    "screenshot_needed": {
      "triggers": {
        "high_priority": [
          {"pattern": "login|sign in|authenticate", "reason": "Login screens prevent access issues"},
          {"pattern": "enter|input|type.*(?:number|amount|date)", "reason": "Data entry benefits from visual reference"},
          {"pattern": "error|warning|alert", "reason": "Error states help troubleshooting"},
          {"pattern": "dropdown|select.*from|choose.*from", "reason": "Selection options may not be obvious"}
        ],
        "medium_priority": [
          {"pattern": "navigate|go to|open", "reason": "Navigation can be clarified visually"},
          {"pattern": "confirm|verify|review", "reason": "Confirmation screens prevent mistakes"},
          {"pattern": "settings|configuration|options", "reason": "Settings pages can be complex"}
        ],
        "low_priority": [
          {"pattern": "click|select.*button|press", "reason": "Simple button clicks usually don't need screenshots"},
          {"pattern": "ok|cancel|close", "reason": "Standard dialog buttons are self-explanatory"}
        ]
      },
      "recommendation_template": "This step involves {action_type}. Screenshots are {priority} priority for this type of action because {reason}."
    },

    "callout_needed": {
      "triggers": {
        "critical": [
          {"pattern": "must|required|mandatory|compliance|legal", "callout_type": "critical"},
          {"pattern": "\\$10,?000|ctr|currency transaction", "callout_type": "critical", "message": "CTR filing requirements"},
          {"pattern": "never|do not|prohibited|forbidden", "callout_type": "critical"}
        ],
        "warning": [
          {"pattern": "careful|caution|attention|important", "callout_type": "warning"},
          {"pattern": "deadline|time.?sensitive|by.*(?:end of day|eod|close)", "callout_type": "warning"},
          {"pattern": "irreversible|cannot be undone|permanent", "callout_type": "warning"}
        ],
        "tip": [
          {"pattern": "best practice|recommended|suggestion|tip", "callout_type": "tip"},
          {"pattern": "shortcut|faster|easier|efficient", "callout_type": "tip"}
        ],
        "info": [
          {"pattern": "note|fyi|for your information|remember", "callout_type": "info"},
          {"pattern": "example|for instance|such as", "callout_type": "info"}
        ]
      }
    },

    "verification_step_needed": {
      "triggers": [
        {"pattern": "enter|input|type", "suggestion": "Add verification step after data entry"},
        {"pattern": "transfer|move|send", "suggestion": "Add confirmation step before completing"},
        {"pattern": "delete|remove|cancel", "suggestion": "Add confirmation step for destructive action"}
      ],
      "recommendation": "Adult learning principle: Verification steps after data entry reduce errors by 40%."
    },

    "troubleshooting_entry_needed": {
      "triggers": [
        {"pattern": "error|fail|issue|problem", "suggestion": "Add to troubleshooting table"},
        {"pattern": "contact.*support|call.*help", "suggestion": "Document escalation path"},
        {"pattern": "try again|retry|restart", "suggestion": "Document recovery steps"}
      ]
    }
  },

  "templates": {
    "screenshot_placeholder": {
      "format": "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  ðŸ“· SCREENSHOT PLACEHOLDER â€” FIGURE {figure_number}                         â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  CAPTURE: {capture_description}                                 â”‚\nâ”‚  SYSTEM:  {system_name}                                         â”‚\nâ”‚  SHOW:    {visible_elements}                                    â”‚\nâ”‚  FOCUS:   {annotation_target}                                   â”‚\nâ”‚  SIZE:    {size_recommendation}                                 â”‚\nâ”‚  ANNOTATIONS:                                                   â”‚\nâ”‚    {annotation_suggestions}                                     â”‚\nâ”‚  NOTES:   {additional_notes}                                    â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    },

    "auto_insert_notification": {
      "format": "âœ“ AUTO-INSERTED\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nPattern detected: \"{pattern_type}\"\n\nâœ“ Auto-inserting: {insert_type}\n  \"{suggested_text}\"\n  {marker}\n\nThis will appear in the generated document with a marker.\nYou can accept, modify, or remove it during final review.\n\nRationale: {rationale}"
    },

    "hard_stop_prompt": {
      "format": "â›” HARD STOP - USER INPUT REQUIRED\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n{reason}\n\nThis is TFCU-specific content that I cannot infer.\n\nPlease provide:\n{required_fields}\n\n(If you skip, I will insert [SME INPUT REQUIRED] markers.)"
    }
  },

  "department_defaults": {
    "Card Services": {
      "quick_reference": [
        {"label": "Card@Once Support", "value": "1-800-237-3387"},
        {"label": "Consumer Debit BIN", "value": "41139300"},
        {"label": "Business Debit BIN", "value": "42616400"},
        {"label": "Card@Once URL", "value": "https://cardatonce.eftsource.com"}
      ],
      "common_systems": ["Card@Once", "GOLD", "FIS Payment One"]
    },
    "Member Services": {
      "quick_reference": [
        {"label": "Member Support", "value": "907-790-5050"}
      ],
      "common_systems": ["GOLD", "Online Banking Admin"]
    },
    "Operations": {
      "quick_reference": [],
      "common_systems": ["GOLD", "FedLine", "ACH System"]
    },
    "Compliance": {
      "quick_reference": [
        {"label": "BSA Officer", "value": "[Name]"},
        {"label": "CTR Threshold", "value": "$10,000"}
      ],
      "common_systems": ["Verafin", "GOLD"]
    }
  },

  "uncertainty_prompts": {
    "description": "Hard-stop question templates for TFCU-specific content that cannot be inferred",

    "tfcu_dollar_limit": {
      "trigger_patterns": ["\\$[\\d,]+(?:\\.\\d{2})?", "limit", "threshold", "maximum", "minimum", "fee"],
      "exclude_patterns": ["\\$10,?000.*ctr", "\\$10,?000.*currency", "ctr.*\\$10,?000"],
      "prompt": "I noticed a dollar amount or threshold that appears to be TFCU-specific.\n\nPlease confirm:\n1. What is the exact amount? $_______\n2. Is this a TFCU policy limit or a regulatory requirement?\n3. Where is this documented? (policy number or regulation)\n\n(TFCU internal limits vary - I cannot assume these values.)",
      "required_fields": ["amount", "source_type", "documentation"],
      "risk_level": "high"
    },

    "tfcu_approval_authority": {
      "trigger_patterns": ["approv", "authoriz", "escalat", "supervisor", "manager", "override"],
      "prompt": "This step involves approval authority.\n\nPlease specify:\n1. WHO can approve this? (title/role, not a specific person's name)\n2. What is the approval limit or scope?\n3. What is the backup if that person is unavailable?\n\n(Approval chains vary by transaction type and amount - I cannot assume.)",
      "required_fields": ["authority_role", "scope", "backup_process"],
      "risk_level": "high"
    },

    "tfcu_contact_information": {
      "trigger_patterns": ["\\d{3}[-.\\s]?\\d{3}[-.\\s]?\\d{4}", "1-?\\d{3}[-.\\s]?\\d{3}[-.\\s]?\\d{4}", "ext\\.?\\s*\\d+", "call", "contact", "phone", "email", "support", "help desk"],
      "prompt": "You mentioned a contact reference.\n\nPlease provide current information:\n1. Exact phone number or extension: _______\n2. Department or role (not a specific person's name): _______\n3. Hours of availability (if applicable): _______\n\n(Contact information changes frequently - I need current, verified data.)",
      "required_fields": ["contact_number", "department_role"],
      "risk_level": "high"
    },

    "tfcu_policy_reference": {
      "trigger_patterns": ["policy", "must", "required", "mandatory", "prohibited", "never", "always"],
      "exclude_patterns": ["ctr", "sar", "bsa", "aml", "ofac", "reg\\s*[a-z]", "regulation"],
      "prompt": "This states a TFCU policy requirement.\n\nPlease specify:\n1. Which TFCU policy document? _______\n2. Is this exact wording from the policy, or your interpretation?\n3. When was this policy last updated?\n\n(Policy citations must be accurate for audit purposes.)",
      "required_fields": ["policy_name", "wording_verified"],
      "risk_level": "high"
    },

    "tfcu_system_details": {
      "trigger_patterns": ["login", "url", "http", "navigate to", "access", "system", "application"],
      "prompt": "This references a system or application.\n\nPlease confirm:\n1. System/application name: _______\n2. Access URL or path (if applicable): _______\n3. Required permissions or access level: _______\n\n(System details must be verified to prevent access issues.)",
      "required_fields": ["system_name", "access_path"],
      "risk_level": "medium"
    },

    "quick_reference_value": {
      "trigger_patterns": ["bin", "routing", "support.*number", "threshold", "cutoff"],
      "prompt": "I detected a value that might go in Quick Reference.\n\nPlease confirm this is current:\n- Label: {detected_label}\n- Value: {detected_value}\n\nIs this accurate? [Yes / No / Update to: _______]",
      "required_fields": ["confirmed"],
      "risk_level": "medium"
    },

    "institutional_knowledge": {
      "trigger_patterns": ["always", "never", "make sure", "don't forget", "remember", "because", "otherwise", "in my experience", "we've found", "workaround"],
      "prompt": "This appears to be institutional knowledge (learned from experience):\n\n\"{extracted_text}\"\n\nPlease confirm:\n1. Is this still accurate guidance?\n2. Should this be formal policy or just a tip?\n3. Who can verify this is correct?\n\n(Experiential knowledge is valuable but should be verified.)",
      "required_fields": ["still_accurate", "formality_level", "verifier"],
      "risk_level": "medium"
    }
  },

  "regulatory_passthrough": {
    "description": "Content the model CAN generate without asking - these are federal/industry requirements, not TFCU-specific",
    "patterns": [
      {
        "id": "ctr_threshold",
        "pattern": "\\$10,?000|ctr|currency transaction report",
        "can_generate": true,
        "standard_text": "Cash transactions over $10,000 require Currency Transaction Report (CTR) filing.",
        "source": "31 CFR 1010.311"
      },
      {
        "id": "sar_filing",
        "pattern": "sar|suspicious activity",
        "can_generate": true,
        "standard_text": "Suspicious activity must be reported per FinCEN requirements.",
        "source": "31 CFR 1020.320"
      },
      {
        "id": "bsa_aml",
        "pattern": "bsa|aml|bank secrecy|anti-money launder",
        "can_generate": true,
        "standard_text": "Follow Bank Secrecy Act (BSA) and Anti-Money Laundering (AML) requirements.",
        "source": "Bank Secrecy Act"
      },
      {
        "id": "ofac_screening",
        "pattern": "ofac|sanction",
        "can_generate": true,
        "standard_text": "Screen against OFAC sanctions list as required.",
        "source": "OFAC SDN List requirements"
      },
      {
        "id": "reg_e_timelines",
        "pattern": "reg\\s*e|error resolution|provisional credit",
        "can_generate": true,
        "standard_text": "Follow Regulation E error resolution timelines.",
        "source": "12 CFR 1005"
      }
    ]
  },

  "intervention_markers": {
    "description": "Format definitions for markers that indicate human intervention is required",
    "marker_types": {
      "verify": {
        "format": "[VERIFY: {content}]",
        "style": {"color": "C00000", "italics": true, "font": "Calibri", "size_pt": 10},
        "use_when": "Value was extracted by pattern matching but not confirmed by user"
      },
      "confirm": {
        "format": "[CONFIRM: {content}]",
        "style": {"color": "C00000", "italics": true, "font": "Calibri", "size_pt": 10},
        "use_when": "Auto-generated content that needs user validation"
      },
      "sme_input": {
        "format": "[SME INPUT REQUIRED: {content}]",
        "style": {"color": "C00000", "italics": true, "font": "Calibri", "size_pt": 10},
        "use_when": "Missing TFCU-specific information that cannot be inferred"
      },
      "missing": {
        "format": "[MISSING: {content}]",
        "style": {"color": "C00000", "italics": true, "font": "Calibri", "size_pt": 10},
        "use_when": "Required field was not provided by user"
      },
      "check": {
        "format": "[CHECK: {content}]",
        "style": {"color": "C00000", "italics": true, "font": "Calibri", "size_pt": 10},
        "use_when": "Inferred content with low confidence"
      },
      "suggested": {
        "format": "[SUGGESTED: {content}]",
        "style": {"color": "C00000", "italics": true, "font": "Calibri", "size_pt": 10},
        "use_when": "Auto-generated content not from source procedure (e.g., quick card warnings)"
      }
    },
    "output_summary": {
      "show_marker_count": true,
      "instruction": "Search for red italic text in the document to find all markers. All markers must be resolved before the procedure is approved."
    }
  },

  "phase_transitions": {
    "description": "Rules for moving between wizard phases, including validation and rollback",

    "transitions": {
      "intake_to_foundation": {
        "from_phase": 1,
        "to_phase": 2,
        "required_fields": ["mode", "procedure_type", "audience", "department"],
        "validation": "All required fields must be present",
        "on_missing": "Prompt for missing fields before proceeding",
        "transition_message": "Great, I have the basics. Now let's define the procedure itself."
      },
      "intake_to_quick_mode": {
        "from_phase": 1,
        "to_phase": 1.5,
        "trigger": "mode == 'quick'",
        "transition_message": "Quick mode selected! I'll ask just a few questions, then generate your output."
      },
      "quick_mode_to_uncertainty": {
        "from_phase": 1.5,
        "to_phase": 3.5,
        "trigger": "hard_stops_found == true",
        "transition_message": "I found some TFCU-specific content that needs verification before I can proceed."
      },
      "quick_mode_to_qa": {
        "from_phase": 1.5,
        "to_phase": 4,
        "trigger": "hard_stops_found == false",
        "transition_message": "Content processed. Running quality checks..."
      },
      "foundation_to_step_construction": {
        "from_phase": 2,
        "to_phase": 3,
        "required_fields": ["title", "overview"],
        "validation": "Title and overview must be valid",
        "on_missing": "Prompt for missing fields",
        "transition_message": "Foundation set. Let's build the steps."
      },
      "step_construction_to_uncertainty": {
        "from_phase": 3,
        "to_phase": 3.5,
        "trigger": "flagged_items.length > 0",
        "skip_if": "flagged_items.length == 0",
        "skip_to": 4,
        "transition_message": "Steps captured. Let's resolve some items that need your input."
      },
      "uncertainty_to_qa": {
        "from_phase": 3.5,
        "to_phase": 4,
        "required": "All critical items resolved OR marked with intervention markers",
        "on_unresolved": "Continue with markers - user will resolve post-generation",
        "transition_message": "Items resolved. Running quality assurance checks..."
      },
      "qa_to_section_validation": {
        "from_phase": 4,
        "to_phase": 4.5,
        "automatic": true,
        "no_user_prompt": true,
        "transition_message": "Validating document structure..."
      },
      "section_validation_to_output": {
        "from_phase": 4.5,
        "to_phase": 5,
        "automatic": true,
        "self_correcting": true,
        "transition_message": "Structure validated. Generating your document bundle..."
      }
    },

    "rollback_rules": {
      "enabled": true,
      "trigger_phrases": [
        "go back",
        "previous",
        "back",
        "redo",
        "start over",
        "restart",
        "let me change",
        "actually"
      ],
      "rollback_actions": {
        "go_back_one": {
          "trigger": ["go back", "previous", "back"],
          "action": "Return to previous phase, preserve all entered data",
          "prompt": "OK, going back to the previous step. Your previous answers are saved."
        },
        "redo_current": {
          "trigger": ["redo", "let me change", "actually"],
          "action": "Clear current phase responses, restart current phase",
          "prompt": "No problem. Let's redo this section. What would you like to change?"
        },
        "start_over": {
          "trigger": ["start over", "restart"],
          "action": "Clear all data, return to Phase 1 intake",
          "confirmation_prompt": "This will clear all your answers and start fresh. Are you sure? (yes/no)",
          "on_confirm": "OK, starting over. What would you like to do?"
        }
      },
      "preserved_on_rollback": [
        "procedure_type",
        "audience",
        "department"
      ],
      "cleared_on_rollback": [
        "current_phase_responses"
      ]
    },

    "error_handling": {
      "on_unexpected_input": {
        "action": "clarify_and_retry",
        "prompt": "I didn't quite understand that. Could you rephrase? Or would you like to:\n1. Continue with the current question\n2. Skip this question (use default)\n3. Go back to the previous step",
        "max_retries": 3,
        "after_max_retries": "I'm having trouble understanding. Let me try a simpler question..."
      },
      "on_validation_failure": {
        "action": "explain_and_retry",
        "prompt_template": "That doesn't quite meet the requirements: {validation_error}. Please try again.",
        "max_retries": 3,
        "after_max_retries": "I'll accept your answer and add a [CHECK] marker for review."
      },
      "on_skip_request": {
        "trigger": ["skip", "not sure", "don't know", "idk", "pass"],
        "response_by_field_type": {
          "required": "This field is required for generation. If you're unsure, I can add a [MISSING] marker.",
          "optional": "OK, skipping this. I'll use the default value.",
          "has_default": "No problem, I'll use: {default_value}"
        }
      }
    },

    "session_commands": {
      "description": "Commands users can invoke at any phase",
      "commands": {
        "help": {
          "triggers": ["help", "?", "what do i do", "explain"],
          "action": "Display context-sensitive help for current question"
        },
        "status": {
          "triggers": ["status", "where am i", "progress"],
          "action": "Show current phase, completed phases, and remaining phases"
        },
        "save": {
          "triggers": ["save", "save progress", "pause"],
          "action": "Acknowledge session state is preserved (auto-save)"
        },
        "summary": {
          "triggers": ["summary", "what have i entered", "review answers"],
          "action": "Display all answers entered so far"
        }
      }
    }
  }
}
